<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Master Database Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e2e8f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header p {
            color: #94a3b8;
            font-size: 14px;
            margin-top: 4px;
        }

        .refresh-btn {
            background: #06b6d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #0891b2;
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .last-updated {
            color: #64748b;
            font-size: 12px;
            margin-top: 8px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
        }

        .stat-card.green {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
            border-color: rgba(34, 197, 94, 0.3);
        }

        .stat-card.yellow {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(234, 179, 8, 0.05));
            border-color: rgba(234, 179, 8, 0.3);
        }

        .stat-card.cyan {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(6, 182, 212, 0.05));
            border-color: rgba(6, 182, 212, 0.3);
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: white;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 13px;
        }

        /* Pending */
        .pending-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .pending-title {
            color: #fbbf24;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .pending-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .pending-tag {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-family: monospace;
        }

        /* Users Grid */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 16px;
        }

        @media (max-width: 440px) {
            .users-grid {
                grid-template-columns: 1fr;
            }
        }

        /* User Card */
        .user-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .user-card:hover {
            border-color: rgba(100, 116, 139, 0.7);
        }

        .user-card.expanded {
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.4);
        }

        .user-header {
            padding: 16px;
            cursor: pointer;
        }

        .user-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #22d3ee, #3b82f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-id {
            font-family: monospace;
            color: #64748b;
            font-size: 13px;
        }

        .user-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }

        .status-badge.active { background: #22c55e; }
        .status-badge.paused { background: #eab308; }
        .status-badge.not-approved { background: #ef4444; }

        .status-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .expand-icon {
            color: #64748b;
            font-size: 18px;
        }

        .user-dinner {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
            font-size: 14px;
        }

        .user-dinner span.time {
            color: #22d3ee;
            font-family: monospace;
        }

        /* Schedule Details */
        .schedule-details {
            border-top: 1px solid rgba(71, 85, 105, 0.5);
            padding: 16px;
            background: rgba(15, 23, 42, 0.3);
        }

        .schedule-title {
            color: #cbd5e1;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .schedule-day {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
        }

        .day-name {
            width: 40px;
            color: #94a3b8;
            font-weight: 500;
            font-size: 13px;
        }

        .day-times {
            display: flex;
            gap: 16px;
        }

        .time-slot {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .time-slot .time {
            color: #cbd5e1;
            font-family: monospace;
        }

        .no-schedule {
            color: #64748b;
            font-style: italic;
            font-size: 14px;
        }

        /* User Details Grid */
        .user-details-grid {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(71, 85, 105, 0.5);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            font-size: 13px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-label {
            color: #64748b;
        }

        .detail-value {
            color: #cbd5e1;
        }

        .detail-value.green { color: #4ade80; }
        .detail-value.red { color: #f87171; }
        .detail-value.yellow { color: #facc15; }
        .detail-value.cyan { color: #22d3ee; }

        /* Loading & Error */
        .loading, .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(6, 182, 212, 0.3);
            border-top-color: #06b6d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            margin-top: 16px;
            color: #94a3b8;
        }

        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-box h2 {
            color: #f87171;
            margin-bottom: 8px;
        }

        .error-box p {
            color: rgba(248, 113, 113, 0.7);
            margin-bottom: 16px;
        }

        .retry-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .retry-btn:hover {
            background: #dc2626;
        }

        /* Footer */
        .footer {
            margin-top: 32px;
            text-align: center;
            color: #64748b;
            font-size: 13px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading database...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="error hidden">
            <div class="error-box">
                <div class="error-icon">‚ùå</div>
                <h2>Failed to Load</h2>
                <p id="error-message">Unknown error</p>
                <button class="retry-btn" onclick="fetchData()">Retry</button>
            </div>
        </div>

        <!-- Main Content -->
        <div id="content" class="hidden">
            <!-- Header -->
            <div class="header">
                <div>
                    <h1>üìä X-Master Database</h1>
                    <p>User schedule management viewer</p>
                    <p class="last-updated" id="last-updated"></p>
                </div>
                <button class="refresh-btn" id="refresh-btn" onclick="fetchData()">
                    üîÑ Refresh
                </button>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="stat-approved">0</div>
                    <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-icon">‚è∏Ô∏è</div>
                    <div class="stat-value" id="stat-paused">0</div>
                    <div class="stat-label">Paused</div>
                </div>
                <div class="stat-card cyan">
                    <div class="stat-icon">üü¢</div>
                    <div class="stat-value" id="stat-active">0</div>
                    <div class="stat-label">Active</div>
                </div>
            </div>

            <!-- Pending -->
            <div id="pending-box" class="pending-box hidden">
                <div class="pending-title">
                    <span>‚è≥</span>
                    <span id="pending-title-text">Pending Users</span>
                </div>
                <div class="pending-tags" id="pending-tags"></div>
            </div>

            <!-- Users -->
            <div class="users-grid" id="users-grid"></div>

            <!-- Footer -->
            <div class="footer">
                <p>Bin ID: 69777539d0ea881f40870137</p>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '$2a$10$dIPImGMre1beYS5BbLUAree2tIlWNdqrb8ARoV86Az04aqIfaPrda';
        const BIN_ID = '69777539d0ea881f40870137';

        const DAYS_ORDER = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        const DAY_LABELS = {
            monday: 'Mon',
            tuesday: 'Tue',
            wednesday: 'Wed',
            thursday: 'Thu',
            friday: 'Fri',
            saturday: 'Sat',
            sunday: 'Sun'
        };

        const LANG_FLAGS = {
            en: 'üá¨üáß',
            de: 'üá©üá™',
            es: 'üá™üá∏',
            fr: 'üá´üá∑',
            it: 'üáÆüáπ',
            ru: 'üá∑üá∫',
            zh: 'üá®üá≥',
            ja: 'üáØüáµ',
            ko: 'üá∞üá∑',
            pt: 'üáµüáπ',
        };

        let expandedUserId = null;

        async function fetchData() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const contentEl = document.getElementById('content');
            const refreshBtn = document.getElementById('refresh-btn');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');
            refreshBtn.disabled = true;

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const json = await response.json();
                renderData(json.record);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

                document.getElementById('last-updated').textContent = 
                    'Last updated: ' + new Date().toLocaleTimeString();

            } catch (err) {
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                document.getElementById('error-message').textContent = err.message;
            } finally {
                refreshBtn.disabled = false;
            }
        }

        function renderData(data) {
            // Stats
            const users = data.users ? Object.values(data.users) : [];
            document.getElementById('stat-total').textContent = users.length;
            document.getElementById('stat-approved').textContent = users.filter(u => u.approved).length;
            document.getElementById('stat-paused').textContent = users.filter(u => u.paused).length;
            document.getElementById('stat-active').textContent = users.filter(u => u.approved && !u.paused).length;

            // Pending
            const pendingBox = document.getElementById('pending-box');
            const pendingTags = document.getElementById('pending-tags');
            if (data.pending && data.pending.length > 0) {
                pendingBox.classList.remove('hidden');
                document.getElementById('pending-title-text').textContent = `Pending Users (${data.pending.length})`;
                pendingTags.innerHTML = data.pending.map(id => 
                    `<span class="pending-tag">${escapeHtml(id)}</span>`
                ).join('');
            } else {
                pendingBox.classList.add('hidden');
            }

            // Users
            const usersGrid = document.getElementById('users-grid');
            if (data.users) {
                usersGrid.innerHTML = Object.entries(data.users).map(([id, user]) => 
                    renderUserCard(id, user)
                ).join('');
            } else {
                usersGrid.innerHTML = '<p style="color: #64748b;">No users found</p>';
            }
        }

        function renderUserCard(id, user) {
            const isExpanded = expandedUserId === id;
            
            let statusClass, statusText;
            if (!user.approved) {
                statusClass = 'not-approved';
                statusText = 'Not Approved';
            } else if (user.paused) {
                statusClass = 'paused';
                statusText = 'Paused';
            } else {
                statusClass = 'active';
                statusText = 'Active';
            }

            const langFlag = LANG_FLAGS[user.lang] || 'üåê';
            const initial = user.username ? user.username.charAt(0).toUpperCase() : '?';

            let scheduleHtml = '';
            if (user.schedule) {
                const days = DAYS_ORDER.filter(day => user.schedule[day]);
                if (days.length > 0) {
                    scheduleHtml = days.map(day => {
                        const sched = user.schedule[day];
                        let timesHtml = '';
                        if (sched.lunch) {
                            timesHtml += `<span class="time-slot">‚òÄÔ∏è <span class="time">${escapeHtml(sched.lunch)}</span></span>`;
                        }
                        if (sched.dinner) {
                            timesHtml += `<span class="time-slot">üåô <span class="time">${escapeHtml(sched.dinner)}</span></span>`;
                        }
                        return `
                            <div class="schedule-day">
                                <span class="day-name">${DAY_LABELS[day]}</span>
                                <div class="day-times">${timesHtml}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    scheduleHtml = '<p class="no-schedule">No schedule configured</p>';
                }
            } else {
                scheduleHtml = '<p class="no-schedule">No schedule configured</p>';
            }

            const dinnerHtml = user.universal_dinner 
                ? `<div class="user-dinner">üçΩÔ∏è Universal Dinner: <span class="time">${escapeHtml(user.universal_dinner)}</span></div>`
                : '';

            return `
                <div class="user-card ${isExpanded ? 'expanded' : ''}" data-id="${escapeHtml(id)}">
                    <div class="user-header" onclick="toggleUser('${escapeHtml(id)}')">
                        <div class="user-top">
                            <div class="user-info">
                                <div class="avatar">${initial}</div>
                                <div>
                                    <div class="user-name">
                                        ${escapeHtml(user.username)}
                                        <span title="${escapeHtml(user.lang.toUpperCase())}">${langFlag}</span>
                                    </div>
                                    <div class="user-id">${escapeHtml(id)}</div>
                                </div>
                            </div>
                            <div class="user-right">
                                <span class="status-badge ${statusClass}">
                                    <span class="status-dot"></span>
                                    ${statusText}
                                </span>
                                <span class="expand-icon">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                            </div>
                        </div>
                        ${dinnerHtml}
                    </div>
                    <div class="schedule-details" style="display: ${isExpanded ? 'block' : 'none'}">
                        <div class="schedule-title">üìÖ Weekly Schedule</div>
                        <div class="schedule-list">${scheduleHtml}</div>
                        <div class="user-details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Language:</span>
                                <span class="detail-value">${escapeHtml(user.lang.toUpperCase())}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Approved:</span>
                                <span class="detail-value ${user.approved ? 'green' : 'red'}">${user.approved ? 'Yes ‚úì' : 'No ‚úó'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Paused:</span>
                                <span class="detail-value ${user.paused ? 'yellow' : 'green'}">${user.paused ? 'Yes ‚è∏' : 'No ‚ñ∂'}</span>
                            </div>
                            ${user.universal_dinner ? `
                                <div class="detail-item">
                                    <span class="detail-label">Universal Dinner:</span>
                                    <span class="detail-value cyan">${escapeHtml(user.universal_dinner)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleUser(id) {
            expandedUserId = expandedUserId === id ? null : id;
            
            document.querySelectorAll('.user-card').forEach(card => {
                const cardId = card.dataset.id;
                const isExpanded = cardId === expandedUserId;
                const details = card.querySelector('.schedule-details');
                const icon = card.querySelector('.expand-icon');
                
                card.classList.toggle('expanded', isExpanded);
                details.style.display = isExpanded ? 'block' : 'none';
                icon.textContent = isExpanded ? '‚ñº' : '‚ñ∂';
            });
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Load data on page load
        fetchData();
    </script>
</body>
</html>
